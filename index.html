<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SyncWatch</title>
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#080810;--surface:#0f0f18;--card:#14141f;--border:#252535;
    --accent:#e8ff47;--accent2:#7c5cfc;--green:#3ddc84;--red:#ff4757;
    --text:#ececf0;--muted:#5a5a72;--r:8px;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh;}
  body::after{
    content:'';position:fixed;inset:0;pointer-events:none;z-index:0;opacity:.15;
    background-image:linear-gradient(var(--border) 1px,transparent 1px),linear-gradient(90deg,var(--border) 1px,transparent 1px);
    background-size:48px 48px;
  }
  header{
    position:relative;z-index:10;padding:1.2rem 2rem;display:flex;align-items:center;gap:1rem;
    border-bottom:1px solid var(--border);background:rgba(8,8,16,.85);backdrop-filter:blur(12px);
  }
  .logo{font-family:'Bebas Neue',sans-serif;font-size:1.9rem;letter-spacing:3px;color:var(--accent);}
  .logo span{color:var(--text);}

  .pill{
    margin-left:auto;display:flex;align-items:center;gap:.5rem;
    background:var(--card);border:1px solid var(--border);
    padding:.35rem .9rem;border-radius:999px;font-size:.78rem;color:var(--muted);transition:all .4s;
  }
  .dot{width:7px;height:7px;border-radius:50%;background:var(--muted);transition:all .4s;flex-shrink:0;}
  .pill.connecting .dot{background:#f5a623;box-shadow:0 0 6px #f5a623;}
  .pill.connected .dot{background:var(--green);box-shadow:0 0 8px var(--green);animation:blink 2.5s infinite;}
  .pill.connected{border-color:rgba(61,220,132,.25);color:var(--text);}
  .pill.proxying .dot{background:var(--accent);box-shadow:0 0 8px var(--accent);animation:blink 1s infinite;}
  .pill.proxying{border-color:rgba(232,255,71,.25);color:var(--accent);}
  .pill.error .dot{background:var(--red);}
  @keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}

  .wrap{
    position:relative;z-index:5;max-width:900px;margin:0 auto;
    padding:1.8rem 1.5rem;display:flex;flex-direction:column;gap:1.2rem;
  }
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:1.2rem 1.4rem;}
  .lbl{font-size:.68rem;font-weight:500;letter-spacing:.14em;text-transform:uppercase;color:var(--muted);margin-bottom:.65rem;}
  .row{display:flex;gap:.7rem;align-items:stretch;}

  input{
    flex:1;background:var(--surface);border:1px solid var(--border);color:var(--text);
    padding:.7rem 1rem;border-radius:var(--r);font-family:inherit;font-size:.88rem;outline:none;
    transition:border-color .2s,box-shadow .2s;
  }
  input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(232,255,71,.07);}
  input::placeholder{color:var(--muted);font-style:italic;}

  button{
    background:var(--accent);color:#080810;border:none;padding:.7rem 1.4rem;border-radius:var(--r);
    font-family:inherit;font-weight:600;font-size:.85rem;cursor:pointer;transition:all .18s;
    white-space:nowrap;display:inline-flex;align-items:center;gap:.4rem;
  }
  button:hover{background:#d4eb00;transform:translateY(-1px);}
  button:active{transform:translateY(0);}
  button.ghost{background:var(--surface);color:var(--text);border:1px solid var(--border);font-weight:400;}
  button.ghost:hover{border-color:var(--accent);color:var(--accent);background:var(--surface);}
  button:disabled{opacity:.4;cursor:not-allowed;transform:none;}

  .share-row{
    margin-top:.8rem;padding-top:.8rem;border-top:1px solid var(--border);
    display:flex;gap:.7rem;align-items:center;
  }
  .share-url{
    flex:1;font-family:'Courier New',monospace;font-size:.75rem;color:var(--muted);
    background:var(--surface);border:1px solid var(--border);padding:.55rem .9rem;
    border-radius:var(--r);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;user-select:all;
  }
  .copied{font-size:.75rem;color:var(--green);opacity:0;transition:opacity .3s;pointer-events:none;}
  .copied.show{opacity:1;}

  /* MODE BADGE */
  .mode-badge{
    display:inline-flex;align-items:center;gap:.4rem;
    padding:.3rem .8rem;border-radius:999px;font-size:.72rem;font-weight:500;
    border:1px solid var(--border);background:var(--surface);color:var(--muted);
    margin-bottom:.7rem;
  }
  .mode-badge.proxy{border-color:rgba(232,255,71,.3);color:var(--accent);background:rgba(232,255,71,.05);}
  .mode-badge.stream{border-color:rgba(124,92,252,.3);color:var(--accent2);background:rgba(124,92,252,.05);}

  /* proxy progress */
  .proxy-info{
    display:none;margin-top:.7rem;padding:.7rem .9rem;
    background:rgba(232,255,71,.05);border:1px solid rgba(232,255,71,.15);
    border-radius:var(--r);font-size:.78rem;color:var(--accent);
  }
  .proxy-info.show{display:block;}
  .pbar-wrap{height:3px;background:var(--border);border-radius:2px;margin-top:.5rem;overflow:hidden;}
  .pbar{height:100%;background:var(--accent);width:0%;transition:width .3s;border-radius:2px;}

  .vwrap{
    position:relative;background:#000;border-radius:var(--r);
    overflow:hidden;aspect-ratio:16/9;border:1px solid var(--border);
  }
  video{width:100%;height:100%;display:block;background:#000;}
  .placeholder{
    position:absolute;inset:0;display:flex;flex-direction:column;
    align-items:center;justify-content:center;gap:1rem;background:var(--surface);
  }
  .placeholder .icon{font-size:3.5rem;opacity:.12;}
  .placeholder p{color:var(--muted);font-size:.88rem;}

  .toast{
    position:absolute;top:.9rem;right:.9rem;background:rgba(8,8,16,.88);
    border:1px solid var(--border);backdrop-filter:blur(12px);
    padding:.4rem .9rem;border-radius:999px;font-size:.72rem;color:var(--accent);
    opacity:0;transform:translateY(-4px);transition:all .3s;pointer-events:none;
  }
  .toast.show{opacity:1;transform:translateY(0);}

  .peers-bar{display:flex;align-items:center;gap:1rem;flex-wrap:wrap;}
  .avatar-row{display:flex;}
  .av{
    width:30px;height:30px;border-radius:50%;border:2px solid var(--bg);
    display:flex;align-items:center;justify-content:center;
    font-size:.75rem;font-weight:600;margin-left:-4px;
  }
  .av:first-child{margin-left:0;}
  .av.me{background:var(--accent);color:#000;}
  .av.p1{background:var(--accent2);color:#fff;}
  .peers-info{flex:1;}
  .peers-info strong{display:block;font-size:.83rem;}
  .peers-info small{font-size:.73rem;color:var(--muted);}
  .badge{padding:.28rem .75rem;border-radius:999px;background:var(--surface);border:1px solid var(--border);font-size:.75rem;color:var(--muted);}
  .badge span{color:var(--accent);font-weight:600;}

  .log{font-size:.75rem;color:var(--muted);font-style:italic;min-height:1.1rem;transition:color .3s;}
  .log.ok{color:var(--green);}
  .log.err{color:var(--red);}

  footer{
    position:relative;z-index:5;text-align:center;
    padding:1.5rem;color:var(--muted);font-size:.72rem;border-top:1px solid var(--border);
  }
</style>
</head>
<body>

<header>
  <div class="logo">Sync<span>Watch</span></div>
  <div class="pill" id="pill"><div class="dot"></div><span id="pillTxt">Iniciandoâ€¦</span></div>
</header>

<div class="wrap">

  <!-- VIDEO URL -->
  <div class="card">
    <div class="lbl">ğŸ¬ Link do vÃ­deo</div>
    <div class="mode-badge" id="modeBadge">â¬¤ DetecÃ§Ã£o automÃ¡tica</div>
    <div class="row">
      <input id="vurl" type="text" placeholder="Cole o link direto (.mp4, .m3u8, googlevideo, etc)â€¦"/>
      <button id="loadBtn" onclick="loadAndBroadcast()">â–¶ Carregar</button>
    </div>
    <!-- proxy progress shown to sender -->
    <div class="proxy-info" id="proxyInfo">
      <span id="proxyTxt">ğŸ“¡ Transmitindo vÃ­deo diretamente para o parceiro via WebRTCâ€¦</span>
      <div class="pbar-wrap"><div class="pbar" id="pbar"></div></div>
    </div>
  </div>

  <!-- SHARE -->
  <div class="card">
    <div class="lbl">ğŸ”— Compartilhar sala</div>
    <div id="log" class="log">Gerando sala P2Pâ€¦</div>
    <div class="share-row">
      <div class="share-url" id="shareUrl">aguardandoâ€¦</div>
      <button class="ghost" onclick="copyLink()">Copiar link</button>
      <span class="copied" id="copied">âœ“ Copiado!</span>
    </div>
  </div>

  <!-- PLAYER -->
  <div class="vwrap">
    <div class="placeholder" id="ph">
      <div class="icon">â–¶</div>
      <p>Cole um link de vÃ­deo acima e clique em Carregar</p>
    </div>
    <video id="vid" controls style="display:none"></video>
    <div class="toast" id="toast"></div>
  </div>

  <!-- PEERS -->
  <div class="card">
    <div class="peers-bar">
      <div class="avatar-row" id="avatarRow"><div class="av me" title="VocÃª">V</div></div>
      <div class="peers-info">
        <strong id="peerTitle">Sala pronta</strong>
        <small id="peerSub">Aguardando outra pessoaâ€¦</small>
      </div>
      <div class="badge">Na sala: <span id="peerN">1</span></div>
    </div>
  </div>

</div>

<footer>SyncWatch Â· WebRTC P2P Â· proxy automÃ¡tico para links IP-locked Â· sem servidor</footer>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROOM SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getRoom(){
  let h=location.hash.slice(1);
  if(!h){h=Math.random().toString(36).slice(2,9);location.hash=h;}
  return h;
}
const ROOM  =getRoom();
const SLOT_A='sw-'+ROOM+'-a';
const SLOT_B='sw-'+ROOM+'-b';
const SHARE =location.href;
document.getElementById('shareUrl').textContent=SHARE;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const vid=document.getElementById('vid');
let peer,conn,mySlot,theirSlot;
let ignoring=false,hls=null,retryTimer=null;

// Proxy state
let proxyMode=false;      // true = we are the sender/proxy
let mediaSource=null;
let sourceBuffer=null;
let sbReady=false;
let proxyQueue=[];
let fetchController=null;
let totalProxied=0;
let proxyMime='video/mp4; codecs="avc1.42E01E, mp4a.40.2"';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setPill(cls,txt){
  const p=document.getElementById('pill');
  p.className='pill '+cls;
  document.getElementById('pillTxt').textContent=txt;
}
let toastTimer;
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg;t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.classList.remove('show'),2500);
}
function setLog(msg,cls=''){
  const l=document.getElementById('log');
  l.textContent=msg;l.className='log '+cls;
}
function setConnected(yes){
  document.getElementById('peerN').textContent=yes?2:1;
  document.getElementById('peerTitle').textContent=yes?'2 pessoas â€” sincronizados!':'Sala pronta';
  document.getElementById('peerSub').textContent=yes?'ConexÃ£o WebRTC direta âœ“':'Aguardando outra pessoaâ€¦';
  const row=document.getElementById('avatarRow');
  const ex=row.querySelector('.p1');
  if(yes&&!ex){const av=document.createElement('div');av.className='av p1';av.title='Parceiro';av.textContent='P';row.appendChild(av);}
  else if(!yes&&ex)ex.remove();
  if(yes)setPill('connected','Conectado âœ“');
  else setPill('connecting','Aguardandoâ€¦');
}
function setModeBadge(mode){
  const b=document.getElementById('modeBadge');
  if(mode==='proxy'){b.className='mode-badge proxy';b.textContent='ğŸ“¡ Modo proxy â€” transmitindo para parceiro';}
  else if(mode==='stream'){b.className='mode-badge stream';b.textContent='ğŸ“º Recebendo stream do parceiro';}
  else{b.className='mode-badge';b.textContent='â¬¤ DetecÃ§Ã£o automÃ¡tica';}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DETECT IP-LOCKED LINK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function isIpLocked(url){
  // googlevideo with &ip= param â€” locked to requester's IP
  return /googlevideo\.com/.test(url)&&/[?&]ip=/.test(url);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PEERJS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initPeer(slot,fallback){
  setLog('Conectando ao servidor de sinalizaÃ§Ã£oâ€¦');
  setPill('connecting','Conectandoâ€¦');
  peer=new Peer(slot,{
    host:'0.peerjs.com',port:443,path:'/',secure:true,debug:0,
    config:{iceServers:[{urls:'stun:stun.l.google.com:19302'},{urls:'stun:stun1.l.google.com:19302'}]}
  });
  peer.on('open',id=>{
    mySlot=id;
    theirSlot=(id===SLOT_A)?SLOT_B:SLOT_A;
    setLog('Sala pronta Â· aguardando parceiroâ€¦','ok');
    setPill('connecting','Aguardando parceiroâ€¦');
    attemptConnect(theirSlot);
  });
  peer.on('connection',c=>setupConn(c));
  peer.on('error',err=>{
    if(err.type==='unavailable-id'&&fallback){peer.destroy();initPeer(fallback,null);return;}
    if(err.type==='peer-unavailable'){clearTimeout(retryTimer);retryTimer=setTimeout(()=>attemptConnect(theirSlot),4000);return;}
    setLog('Erro: '+err.type,'err');setPill('error','Erro');
  });
  peer.on('disconnected',()=>{setLog('Reconectandoâ€¦','err');peer.reconnect();});
}
function attemptConnect(target){
  if(conn&&conn.open)return;
  // Use binary for proxy chunks, but we'll handle type in data
  const c=peer.connect(target,{reliable:true,serialization:'binary'});
  setupConn(c);
}
function setupConn(c){
  c.on('open',()=>{
    conn=c;clearTimeout(retryTimer);
    setConnected(true);
    setLog('ConexÃ£o P2P direta estabelecida!','ok');
    const url=document.getElementById('vurl').value.trim();
    if(url){
      setTimeout(()=>{
        const locked=isIpLocked(url);
        if(locked){
          // Tell partner to prepare for proxy stream
          sendMsg({type:'proxy_start',mime:proxyMime});
          startProxy(url);
        } else {
          sendMsg({type:'load',url,currentTime:vid.currentTime,paused:vid.paused});
        }
      },400);
    }
  });
  c.on('data',onData);
  c.on('close',()=>{
    conn=null;setConnected(false);
    setLog('Parceiro desconectou.','err');
    clearTimeout(retryTimer);
    retryTimer=setTimeout(()=>attemptConnect(theirSlot),3000);
  });
  c.on('error',e=>setLog('Erro: '+e,'err'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MESSAGING  (JSON wrapped in Uint8Array for binary channel)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ENC=new TextEncoder();
const DEC=new TextDecoder();

function sendMsg(obj){
  if(!conn||!conn.open)return;
  // prefix with 0x01 = control message
  const json=JSON.stringify(obj);
  const buf=new Uint8Array(json.length+1);
  buf[0]=0x01;
  for(let i=0;i<json.length;i++)buf[i+1]=json.charCodeAt(i);
  conn.send(buf.buffer);
}
function sendChunk(ab){
  if(!conn||!conn.open)return;
  // prefix 0x02 = video chunk
  const src=new Uint8Array(ab);
  const out=new Uint8Array(src.length+1);
  out[0]=0x02;
  out.set(src,1);
  conn.send(out.buffer);
}

function onData(raw){
  let arr;
  if(raw instanceof ArrayBuffer)arr=new Uint8Array(raw);
  else if(raw instanceof Uint8Array)arr=raw;
  else{
    // fallback plain object (shouldn't happen with binary serialization)
    try{handleMsg(typeof raw==='string'?JSON.parse(raw):raw);}catch(e){}
    return;
  }
  const type=arr[0];
  if(type===0x01){
    // control
    try{handleMsg(JSON.parse(DEC.decode(arr.slice(1))));}catch(e){console.error(e);}
  } else if(type===0x02){
    // video chunk
    handleChunk(arr.slice(1).buffer);
  }
}

function handleMsg(msg){
  if(!msg||!msg.type)return;

  if(msg.type==='load'){
    ignoring=true;
    loadVideo(msg.url);
    document.getElementById('vurl').value=msg.url;
    showToast('ğŸ¬ Parceiro carregou um vÃ­deo');
    setTimeout(()=>{
      if(typeof msg.currentTime==='number')vid.currentTime=msg.currentTime;
      if(!msg.paused)vid.play().catch(()=>{});
      ignoring=false;
    },900);
    return;
  }

  if(msg.type==='proxy_start'){
    // Partner will stream the video to us
    proxyMime=msg.mime||proxyMime;
    setModeBadge('stream');
    setLog('Recebendo stream do parceiroâ€¦','ok');
    showToast('ğŸ“º Recebendo vÃ­deo do parceiroâ€¦');
    setupMediaSource();
    return;
  }

  if(msg.type==='proxy_mime'){
    // update mime after initial detection
    proxyMime=msg.mime;
    if(sourceBuffer&&!sbReady){
      // sourceBuffer already added with wrong mime, recreate
      // just proceed, browser will try
    }
    return;
  }

  if(msg.type==='proxy_done'){
    showToast('âœ… Stream completo');
    if(sourceBuffer&&mediaSource&&mediaSource.readyState==='open'){
      try{
        if(!sourceBuffer.updating)mediaSource.endOfStream();
        else sourceBuffer.addEventListener('updateend',()=>{try{mediaSource.endOfStream();}catch(e){}},{once:true});
      }catch(e){}
    }
    return;
  }

  if(msg.type==='proxy_error'){
    setLog('Erro no proxy: '+msg.msg,'err');
    showToast('âŒ Erro ao buscar vÃ­deo');
    return;
  }

  // Playback sync
  ignoring=true;
  if(msg.type==='play'){
    const drift=(Date.now()-msg.ts)/1000;
    const target=msg.currentTime+drift;
    if(Math.abs(vid.currentTime-target)>1.5)vid.currentTime=target;
    vid.play().catch(()=>{});
    showToast('â–¶ Parceiro deu play');
  } else if(msg.type==='pause'){
    vid.pause();
    if(Math.abs(vid.currentTime-msg.currentTime)>1)vid.currentTime=msg.currentTime;
    showToast('â¸ Parceiro pausou');
  } else if(msg.type==='seek'){
    vid.currentTime=msg.currentTime;
    showToast('â© Parceiro avanÃ§ou');
  }
  setTimeout(()=>{ignoring=false;},400);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROXY: sender fetches video and streams chunks via WebRTC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startProxy(url){
  proxyMode=true;
  setModeBadge('proxy');
  setPill('proxying','Transmitindoâ€¦');
  document.getElementById('proxyInfo').classList.add('show');
  document.getElementById('proxyTxt').textContent='ğŸ“¡ Buscando vÃ­deo e transmitindo para o parceiroâ€¦';

  fetchController=new AbortController();
  try{
    const resp=await fetch(url,{signal:fetchController.signal,mode:'cors',credentials:'omit'});
    if(!resp.ok)throw new Error('HTTP '+resp.status);

    // Detect real MIME from Content-Type
    const ct=resp.headers.get('content-type')||'';
    let detectedMime='video/mp4';
    if(ct.includes('mp4'))detectedMime='video/mp4';
    else if(ct.includes('webm'))detectedMime='video/webm';
    else if(ct.includes('ogg'))detectedMime='video/ogg';

    proxyMime=detectedMime+'; codecs="avc1.42E01E, mp4a.40.2"';
    // Tell partner actual mime
    sendMsg({type:'proxy_mime',mime:proxyMime});

    const contentLength=parseInt(resp.headers.get('content-length')||'0');
    const reader=resp.body.getReader();
    let received=0;

    while(true){
      const {done,value}=await reader.read();
      if(done)break;
      sendChunk(value.buffer);
      received+=value.length;
      totalProxied=received;
      if(contentLength>0){
        const pct=Math.min(100,Math.round(received/contentLength*100));
        document.getElementById('pbar').style.width=pct+'%';
        document.getElementById('proxyTxt').textContent=
          `ğŸ“¡ Transmitindoâ€¦ ${pct}% (${(received/1024/1024).toFixed(1)} MB)`;
      } else {
        document.getElementById('proxyTxt').textContent=
          `ğŸ“¡ Transmitindoâ€¦ ${(received/1024/1024).toFixed(1)} MB enviados`;
      }
    }
    sendMsg({type:'proxy_done'});
    document.getElementById('proxyTxt').textContent='âœ… TransmissÃ£o completa!';
    document.getElementById('pbar').style.width='100%';
    setPill('connected','Conectado âœ“');

  } catch(e){
    if(e.name==='AbortError')return;
    console.error('Proxy fetch error:',e);
    sendMsg({type:'proxy_error',msg:e.message});
    setLog('Erro ao buscar vÃ­deo: '+e.message,'err');
    // Fallback: try to send URL directly anyway
    sendMsg({type:'load',url,currentTime:vid.currentTime,paused:vid.paused});
    setModeBadge('auto');
    document.getElementById('proxyInfo').classList.remove('show');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROXY: receiver â€” MediaSource + SourceBuffer
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setupMediaSource(){
  document.getElementById('ph').style.display='none';
  vid.style.display='block';

  // Try to find a supported codec combo
  const candidates=[
    'video/mp4; codecs="avc1.42E01E, mp4a.40.2"',
    'video/mp4; codecs="avc1.64001E, mp4a.40.2"',
    'video/mp4',
    'video/webm; codecs="vp8, vorbis"',
    'video/webm; codecs="vp9"',
    'video/webm',
  ];
  let mime=proxyMime;
  if(!MediaSource.isTypeSupported(mime)){
    mime=candidates.find(c=>MediaSource.isTypeSupported(c))||'video/mp4';
  }

  mediaSource=new MediaSource();
  vid.src=URL.createObjectURL(mediaSource);
  proxyQueue=[];
  sbReady=false;
  sourceBuffer=null;

  mediaSource.addEventListener('sourceopen',()=>{
    try{
      sourceBuffer=mediaSource.addSourceBuffer(mime);
      sourceBuffer.mode='sequence';
      sbReady=true;
      sourceBuffer.addEventListener('updateend',flushQueue);
      flushQueue();
    }catch(e){
      setLog('MediaSource erro: '+e.message,'err');
      console.error(e);
    }
  });
}

function handleChunk(ab){
  proxyQueue.push(ab);
  if(sbReady&&sourceBuffer&&!sourceBuffer.updating)flushQueue();
}

function flushQueue(){
  if(!sbReady||!sourceBuffer||sourceBuffer.updating||proxyQueue.length===0)return;
  if(mediaSource.readyState!=='open')return;
  const chunk=proxyQueue.shift();
  try{
    sourceBuffer.appendBuffer(chunk);
  }catch(e){
    console.error('appendBuffer error:',e);
    // If quota exceeded, try to remove old data
    if(e.name==='QuotaExceededError'&&vid.currentTime>30){
      try{
        sourceBuffer.remove(0,vid.currentTime-10);
        // re-queue
        proxyQueue.unshift(chunk);
      }catch(e2){console.error(e2);}
    }
  }
  // Auto-play once we have some buffered
  if(vid.paused&&vid.readyState>=2){
    vid.play().catch(()=>{});
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLAYER EVENTS â†’ SYNC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
vid.addEventListener('play',()=>{if(!ignoring)sendMsg({type:'play',currentTime:vid.currentTime,ts:Date.now()});});
vid.addEventListener('pause',()=>{if(!ignoring)sendMsg({type:'pause',currentTime:vid.currentTime});});
let lastSeek=0;
vid.addEventListener('seeked',()=>{
  if(ignoring)return;
  const now=Date.now();if(now-lastSeek<500)return;lastSeek=now;
  sendMsg({type:'seek',currentTime:vid.currentTime});
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOAD VIDEO (normal, non-locked)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadVideo(url){
  if(hls){hls.destroy();hls=null;}
  document.getElementById('ph').style.display='none';
  vid.style.display='block';
  if(/\.m3u8/i.test(url)||/m3u8/i.test(url)){
    if(Hls.isSupported()){hls=new Hls({enableWorker:false});hls.loadSource(url);hls.attachMedia(vid);}
    else if(vid.canPlayType('application/vnd.apple.mpegurl'))vid.src=url;
    else setLog('HLS nÃ£o suportado.','err');
  } else {
    vid.src=url;
  }
}

function loadAndBroadcast(){
  const url=document.getElementById('vurl').value.trim();
  if(!url)return;

  const locked=isIpLocked(url);

  // Load locally first (we have the right IP)
  loadVideo(url);
  setModeBadge(locked?'proxy':'auto');

  if(conn&&conn.open){
    if(locked){
      // Stream to partner instead of sending URL
      sendMsg({type:'proxy_start',mime:proxyMime});
      startProxy(url);
    } else {
      sendMsg({type:'load',url,currentTime:0,paused:true});
    }
  } else {
    // No partner yet â€” will sync when they connect (in setupConn open handler)
    setLog('VÃ­deo carregado. Aguardando parceiro para sincronizarâ€¦','ok');
  }
}

document.getElementById('vurl').addEventListener('keydown',e=>{if(e.key==='Enter')loadAndBroadcast();});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COPY LINK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function copyLink(){
  navigator.clipboard.writeText(SHARE).then(()=>{
    const c=document.getElementById('copied');
    c.classList.add('show');setTimeout(()=>c.classList.remove('show'),2000);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// START
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
initPeer(SLOT_A,SLOT_B);
</script>
</body>
</html>
