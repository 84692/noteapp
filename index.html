<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SyncWatch</title>
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #080810;
    --surface: #0f0f18;
    --card: #14141f;
    --border: #252535;
    --accent: #e8ff47;
    --accent2: #7c5cfc;
    --green: #3ddc84;
    --red: #ff4757;
    --text: #ececf0;
    --muted: #5a5a72;
    --r: 8px;
  }
  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
  }

  body::after {
    content:'';
    position:fixed;
    inset:0;
    background-image:
      linear-gradient(var(--border) 1px, transparent 1px),
      linear-gradient(90deg, var(--border) 1px, transparent 1px);
    background-size: 48px 48px;
    opacity:0.18;
    pointer-events:none;
    z-index:0;
  }

  header {
    position:relative;
    z-index:10;
    padding: 1.2rem 2rem;
    display:flex;
    align-items:center;
    gap:1rem;
    border-bottom:1px solid var(--border);
    background: rgba(8,8,16,0.8);
    backdrop-filter: blur(12px);
  }

  .logo {
    font-family:'Bebas Neue', sans-serif;
    font-size:1.9rem;
    letter-spacing:3px;
    color:var(--accent);
  }
  .logo span { color:var(--text); }

  .status-pill {
    margin-left:auto;
    display:flex;
    align-items:center;
    gap:0.5rem;
    background:var(--card);
    border:1px solid var(--border);
    padding:0.35rem 0.9rem;
    border-radius:999px;
    font-size:0.78rem;
    color:var(--muted);
    transition: all 0.4s;
  }
  .dot { width:7px; height:7px; border-radius:50%; background:var(--muted); transition: all 0.4s; flex-shrink:0; }
  .status-pill.connecting .dot { background:#f5a623; box-shadow:0 0 6px #f5a623; }
  .status-pill.connected  .dot { background:var(--green); box-shadow:0 0 8px var(--green); animation:blink 2.5s infinite; }
  .status-pill.connected  { border-color:rgba(61,220,132,0.25); color:var(--text); }
  .status-pill.error      .dot { background:var(--red); }

  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.4} }

  .wrap {
    position:relative;
    z-index:5;
    max-width:900px;
    margin:0 auto;
    padding:1.8rem 1.5rem;
    display:flex;
    flex-direction:column;
    gap:1.2rem;
  }

  .card {
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--r);
    padding:1.2rem 1.4rem;
  }

  .label {
    font-size:0.68rem;
    font-weight:500;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:var(--muted);
    margin-bottom:.65rem;
  }

  .row { display:flex; gap:.7rem; align-items:stretch; }

  input {
    flex:1;
    background:var(--surface);
    border:1px solid var(--border);
    color:var(--text);
    padding:.7rem 1rem;
    border-radius:var(--r);
    font-family:inherit;
    font-size:.88rem;
    outline:none;
    transition: border-color .2s, box-shadow .2s;
  }
  input:focus { border-color:var(--accent); box-shadow:0 0 0 3px rgba(232,255,71,.07); }
  input::placeholder { color:var(--muted); font-style:italic; }

  button {
    background:var(--accent);
    color:#080810;
    border:none;
    padding:.7rem 1.4rem;
    border-radius:var(--r);
    font-family:inherit;
    font-weight:600;
    font-size:.85rem;
    cursor:pointer;
    transition: all .18s;
    white-space:nowrap;
    display:inline-flex;
    align-items:center;
    gap:.4rem;
  }
  button:hover { background:#d4eb00; transform:translateY(-1px); }
  button:active { transform:translateY(0); }
  button.ghost {
    background:var(--surface);
    color:var(--text);
    border:1px solid var(--border);
    font-weight:400;
  }
  button.ghost:hover { border-color:var(--accent); color:var(--accent); background:var(--surface); }

  .share-row {
    margin-top:.8rem;
    padding-top:.8rem;
    border-top:1px solid var(--border);
    display:flex;
    gap:.7rem;
    align-items:center;
  }
  .share-url {
    flex:1;
    font-family:'Courier New',monospace;
    font-size:.75rem;
    color:var(--muted);
    background:var(--surface);
    border:1px solid var(--border);
    padding:.55rem .9rem;
    border-radius:var(--r);
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    cursor:default;
    user-select:all;
  }
  .copied { font-size:.75rem; color:var(--green); opacity:0; transition:opacity .3s; pointer-events:none; }
  .copied.show { opacity:1; }

  .vwrap {
    position:relative;
    background:#000;
    border-radius:var(--r);
    overflow:hidden;
    aspect-ratio:16/9;
    border:1px solid var(--border);
  }
  video { width:100%; height:100%; display:block; background:#000; }

  .placeholder {
    position:absolute;
    inset:0;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:1rem;
    background:var(--surface);
  }
  .placeholder .icon { font-size:3.5rem; opacity:.12; }
  .placeholder p { color:var(--muted); font-size:.88rem; }

  .toast {
    position:absolute;
    top:.9rem;
    right:.9rem;
    background:rgba(8,8,16,.88);
    border:1px solid var(--border);
    backdrop-filter:blur(12px);
    padding:.4rem .9rem;
    border-radius:999px;
    font-size:.72rem;
    color:var(--accent);
    opacity:0;
    transform:translateY(-4px);
    transition: all .3s;
    pointer-events:none;
  }
  .toast.show { opacity:1; transform:translateY(0); }

  .peers-bar { display:flex; align-items:center; gap:1rem; flex-wrap:wrap; }
  .avatar-row { display:flex; }
  .av {
    width:30px; height:30px;
    border-radius:50%;
    border:2px solid var(--bg);
    display:flex; align-items:center; justify-content:center;
    font-size:.75rem; font-weight:600;
    margin-left:-4px;
  }
  .av:first-child { margin-left:0; }
  .av.me  { background:var(--accent);  color:#000; }
  .av.p1  { background:var(--accent2); color:#fff; }

  .peers-info { flex:1; }
  .peers-info strong { display:block; font-size:.83rem; }
  .peers-info small  { font-size:.73rem; color:var(--muted); }

  .badge {
    padding:.28rem .75rem;
    border-radius:999px;
    background:var(--surface);
    border:1px solid var(--border);
    font-size:.75rem; color:var(--muted);
  }
  .badge span { color:var(--accent); font-weight:600; }

  .log {
    font-size:.75rem; color:var(--muted); font-style:italic;
    min-height:1.1rem; transition: color .3s;
  }
  .log.ok   { color:var(--green); }
  .log.err  { color:var(--red); }
  .log.info { color:var(--accent); }

  #debugLog {
    background:#111;
    border:1px solid #333;
    padding:10px;
    font-size:0.8rem;
    color:#ccc;
    max-height:180px;
    overflow-y:auto;
    white-space:pre-wrap;
    border-radius:var(--r);
    margin-top:8px;
  }

  footer {
    position:relative; z-index:5;
    text-align:center;
    padding:1.5rem;
    color:var(--muted);
    font-size:.72rem;
    border-top:1px solid var(--border);
  }
</style>
</head>
<body>

<header>
  <div class="logo">Sync<span>Watch</span></div>
  <div class="status-pill" id="pill">
    <div class="dot"></div>
    <span id="pillTxt">Iniciando‚Ä¶</span>
  </div>
</header>

<div class="wrap">

  <div class="card">
    <div class="label">üé¨ Link direto do v√≠deo</div>
    <div class="row">
      <input id="vurl" type="text" placeholder="https://‚Ä¶  (.mp4 direto ou link com CORS aberto)" />
      <button onclick="loadAndBroadcast()">‚ñ∂ Carregar</button>
    </div>
  </div>

  <div class="card">
    <div class="label">üîó Compartilhar sala</div>
    <div id="log" class="log">Gerando sala P2P‚Ä¶</div>
    <div class="share-row">
      <div class="share-url" id="shareUrl">aguardando‚Ä¶</div>
      <button class="ghost" onclick="copyLink()">Copiar link</button>
      <span class="copied" id="copied">‚úì Copiado!</span>
    </div>
  </div>

  <div class="vwrap">
    <div class="placeholder" id="ph">
      <div class="icon">‚ñ∂</div>
      <p>Cole um link de v√≠deo acima e clique em Carregar</p>
    </div>
    <video id="vid" controls style="display:none"></video>
    <button id="btnDownload" onclick="baixarVideo()" style="display:none; margin:12px auto; background:#e8ff47; color:#000; padding:12px 24px; border:none; border-radius:6px; font-weight:bold; cursor:pointer; font-size:1rem;">
      BAIXAR V√çDEO PERMANENTE (.MP4)
    </button>
    <div class="toast" id="toast"></div>
    <div id="debugLog"></div>
  </div>

  <div class="card">
    <div class="peers-bar">
      <div class="avatar-row" id="avatarRow">
        <div class="av me" title="Voc√™">V</div>
      </div>
      <div class="peers-info">
        <strong id="peerTitle">Sala pronta</strong>
        <small id="peerSub">Aguardando outra pessoa entrar‚Ä¶</small>
      </div>
      <div class="badge">Na sala: <span id="peerN">1</span></div>
    </div>
  </div>

</div>

<footer>SyncWatch ¬∑ WebRTC via PeerJS ¬∑ conex√£o direta entre navegadores ¬∑ sem servidor</footer>

<script>
// Debug log function
function logDebug(msg, type = 'info') {
  const logEl = document.getElementById('debugLog');
  const prefix = type === 'err' ? '‚ùå ' : type === 'ok' ? '‚úÖ ' : '‚ÑπÔ∏è ';
  const color = type === 'err' ? '#ff4757' : type === 'ok' ? '#3ddc84' : '#e8ff47';
  logEl.innerHTML += `<div style="color:${color}">${prefix}${new Date().toLocaleTimeString()} - ${msg}</div>`;
  logEl.scrollTop = logEl.scrollHeight;
}

// ‚îÄ‚îÄ‚îÄ Room setup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getRoom() {
  let h = location.hash.slice(1);
  if (!h) { h = Math.random().toString(36).slice(2,9); location.hash = h; }
  return h;
}
const ROOM   = getRoom();
const SLOT_A = 'sw-' + ROOM + '-a';
const SLOT_B = 'sw-' + ROOM + '-b';
const SHARE  = location.href;
document.getElementById('shareUrl').textContent = SHARE;

// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const vid = document.getElementById('vid');
let peer, conn;
let mySlot, theirSlot;
let ignoring = false;
let hls = null;
let retryTimer = null;

// ‚îÄ‚îÄ‚îÄ UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setPill(cls, txt) {
  const p = document.getElementById('pill');
  p.className = 'status-pill ' + cls;
  document.getElementById('pillTxt').textContent = txt;
}
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2500);
}
function setLog(msg, cls='') {
  const l = document.getElementById('log');
  l.textContent = msg; l.className = 'log ' + cls;
}
function setConnected(yes) {
  document.getElementById('peerN').textContent = yes ? 2 : 1;
  document.getElementById('peerTitle').textContent  = yes ? '2 pessoas na sala ‚Äî sincronizados!' : 'Sala pronta';
  document.getElementById('peerSub').textContent    = yes ? 'Conex√£o WebRTC direta ativa ‚úì' : 'Aguardando outra pessoa entrar‚Ä¶';
  const row = document.getElementById('avatarRow');
  const ex  = row.querySelector('.p1');
  if (yes && !ex) {
    const av = document.createElement('div');
    av.className='av p1'; av.title='Parceiro'; av.textContent='P';
    row.appendChild(av);
  } else if (!yes && ex) ex.remove();
  if (yes) setPill('connected','Conectado ‚úì');
  else     setPill('connecting','Aguardando‚Ä¶');
}

// ‚îÄ‚îÄ‚îÄ PeerJS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initPeer(slot, fallbackSlot) {
  setLog('Conectando ao servidor de sinaliza√ß√£o‚Ä¶');
  setPill('connecting','Conectando‚Ä¶');
  logDebug('Iniciando Peer com slot: ' + slot);

  peer = new Peer(slot, {
    host: '0.peerjs.com',
    port: 443,
    path: '/',
    secure: true,
    debug: 0,
    config: {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' }
      ]
    }
  });

  peer.on('open', id => {
    mySlot    = id;
    theirSlot = (id === SLOT_A) ? SLOT_B : SLOT_A;
    setLog('Sala pronta ¬∑ ID: ' + id.slice(-8) + ' ¬∑ aguardando parceiro‚Ä¶', 'ok');
    setPill('connecting', 'Aguardando parceiro‚Ä¶');
    logDebug('Peer aberto. Meu ID: ' + id + ' | Parceiro esperado: ' + theirSlot, 'ok');
    if (id === SLOT_B) attemptConnect(SLOT_A);
    else attemptConnect(SLOT_B);
  });

  peer.on('connection', c => setupConn(c));

  peer.on('error', err => {
    logDebug('PeerJS erro: ' + err.type + ' - ' + err.message, 'err');
    if (err.type === 'unavailable-id' && fallbackSlot) {
      peer.destroy();
      initPeer(fallbackSlot, null);
      return;
    }
    if (err.type === 'peer-unavailable') {
      clearTimeout(retryTimer);
      retryTimer = setTimeout(() => attemptConnect(theirSlot), 4000);
      return;
    }
    setLog('Erro PeerJS: ' + err.type, 'err');
    setPill('error', 'Erro');
  });

  peer.on('disconnected', () => {
    setLog('Servidor de sinaliza√ß√£o desconectou. Reconectando‚Ä¶', 'err');
    logDebug('Peer desconectado do signaling, reconectando...', 'err');
    peer.reconnect();
  });
}

function attemptConnect(target) {
  if (conn && conn.open) return;
  logDebug('Tentando conectar ao peer: ' + target);
  const c = peer.connect(target, { reliable:true, serialization:'json' });
  setupConn(c);
}

function setupConn(c) {
  c.on('open', () => {
    conn = c;
    clearTimeout(retryTimer);
    setConnected(true);
    setLog('Conex√£o P2P direta estabelecida!', 'ok');
    logDebug('Conex√£o P2P aberta com sucesso!', 'ok');
    const url = document.getElementById('vurl').value.trim();
    if (url) {
      setTimeout(() => {
        send({ type:'load', url, currentTime: vid.currentTime, paused: vid.paused });
        logDebug('Enviado estado atual do v√≠deo pro peer');
      }, 400);
    }
  });

  c.on('data', onData);

  c.on('close', () => {
    conn = null;
    setConnected(false);
    setLog('Parceiro desconectou.', 'err');
    logDebug('Parceiro desconectou. Tentando reconectar em 3s...', 'err');
    clearTimeout(retryTimer);
    retryTimer = setTimeout(() => attemptConnect(theirSlot), 3000);
  });

  c.on('error', e => {
    logDebug('Erro na conex√£o de dados: ' + e, 'err');
    setLog('Erro de dados: ' + e, 'err');
  });
}

// ‚îÄ‚îÄ‚îÄ Receive ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onData(msg) {
  if (!msg || !msg.type) return;
  ignoring = true;
  logDebug('Recebido msg do peer: ' + JSON.stringify(msg));

  if (msg.type === 'load') {
    if (msg.url && msg.url !== vid.src) {
      logDebug('Peer carregou v√≠deo: ' + msg.url);
      loadVideo(msg.url);
      document.getElementById('vurl').value = msg.url;
      showToast('üé¨ Parceiro carregou um v√≠deo');
      setLog('V√≠deo sincronizado do parceiro', 'ok');
    }
    setTimeout(() => {
      if (typeof msg.currentTime === 'number') vid.currentTime = msg.currentTime;
      if (!msg.paused) vid.play().catch(e => logDebug('Play falhou: ' + e.message, 'err'));
      ignoring = false;
    }, 900);
    return;
  }

  if (msg.type === 'play') {
    const drift  = (Date.now() - msg.ts) / 1000;
    const target = msg.currentTime + drift;
    if (Math.abs(vid.currentTime - target) > 1.5) vid.currentTime = target;
    vid.play().catch(e => logDebug('Play remoto falhou: ' + e.message, 'err'));
    showToast('‚ñ∂ Parceiro deu play');
  } else if (msg.type === 'pause') {
    vid.pause();
    if (Math.abs(vid.currentTime - msg.currentTime) > 1) vid.currentTime = msg.currentTime;
    showToast('‚è∏ Parceiro pausou');
  } else if (msg.type === 'seek') {
    vid.currentTime = msg.currentTime;
    showToast('‚è© Parceiro avan√ßou para ' + fmtTime(msg.currentTime));
  }

  setTimeout(() => { ignoring = false; }, 400);
}

function fmtTime(s) {
  const m = Math.floor(s/60), sec = Math.floor(s%60);
  return m + ':' + String(sec).padStart(2,'0');
}

// ‚îÄ‚îÄ‚îÄ Send ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function send(msg) {
  if (conn && conn.open) {
    conn.send(msg);
    logDebug('Enviado: ' + JSON.stringify(msg));
  } else {
    logDebug('Tentou enviar mas conn n√£o aberta', 'err');
  }
}

// ‚îÄ‚îÄ‚îÄ Player events ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
vid.addEventListener('play',  () => {
  if (ignoring) return;
  send({ type:'play', currentTime: vid.currentTime, ts: Date.now() });
});
vid.addEventListener('pause', () => {
  if (ignoring) return;
  send({ type:'pause', currentTime: vid.currentTime });
});
let lastSeek = 0;
vid.addEventListener('seeked', () => {
  if (ignoring) return;
  const now = Date.now();
  if (now - lastSeek < 500) return;
  lastSeek = now;
  send({ type:'seek', currentTime: vid.currentTime });
});

vid.addEventListener('error', (e) => {
  const errMsg = e.message || 'Erro desconhecido no v√≠deo';
  logDebug('ERRO NO V√çDEO: ' + errMsg + ' (prov√°vel CORS ou link inv√°lido)', 'err');
  showToast('Erro no v√≠deo - veja logs abaixo');
});

// ‚îÄ‚îÄ‚îÄ Load video ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadVideo(url) {
  logDebug('Tentando carregar v√≠deo: ' + url);
  if (hls) { hls.destroy(); hls = null; }
  document.getElementById('ph').style.display = 'none';
  vid.style.display = 'block';

  if (/\.m3u8/i.test(url) || /m3u8/i.test(url)) {
    logDebug('Detectado HLS (.m3u8) - pode falhar se n√£o tiver CORS');
    if (Hls.isSupported()) {
      hls = new Hls({ enableWorker: false });
      hls.loadSource(url);
      hls.attachMedia(vid);
      hls.on(Hls.Events.ERROR, (event, data) => {
        logDebug('HLS erro: ' + data.details + ' - type: ' + data.type, 'err');
      });
    } else if (vid.canPlayType('application/vnd.apple.mpegurl')) {
      vid.src = url;
    } else {
      logDebug('HLS n√£o suportado neste navegador', 'err');
    }
  } else {
    logDebug('Carregando como v√≠deo direto (.mp4 ou similar)');
    vid.src = url;
  }

  // Tenta play auto pra testar logo
  setTimeout(() => {
    vid.play().catch(e => logDebug('Auto-play inicial falhou: ' + e.message + ' (normal se sem intera√ß√£o)', 'err'));
  }, 1500);
}

function loadAndBroadcast() {
  const url = document.getElementById('vurl').value.trim();
  if (!url) {
    logDebug('Nenhum URL informado', 'err');
    return;
  }
  logDebug('Voc√™ carregou: ' + url + ' - enviando pros peers');
  loadVideo(url);
  send({ type:'load', url, currentTime: 0, paused: true });
}

document.getElementById('vurl').addEventListener('keydown', e => {
  if (e.key === 'Enter') loadAndBroadcast();
});

// ‚îÄ‚îÄ‚îÄ Copy link ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function copyLink() {
  navigator.clipboard.writeText(SHARE).then(() => {
    const c = document.getElementById('copied');
    c.classList.add('show');
    setTimeout(() => c.classList.remove('show'), 2000);
  });
}

// ‚îÄ‚îÄ‚îÄ Download button logic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
vid.addEventListener('playing', () => {
  document.getElementById('btnDownload').style.display = 'block';
});

async function baixarVideo() {
  const src = vid.currentSrc || vid.src;
  if (!src) {
    alert("Nenhum v√≠deo carregado.");
    return;
  }

  try {
    const response = await fetch(src, { mode: 'cors' });
    if (!response.ok) throw new Error("Status " + response.status);

    const blob = await response.blob();
    const urlBlob = window.URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = urlBlob;
    a.download = "syncwatch_" + Date.now() + ".mp4";
    document.body.appendChild(a);
    a.click();
    
    setTimeout(() => {
      document.body.removeChild(a);
      window.URL.revokeObjectURL(urlBlob);
    }, 100);

  } catch (err) {
    logDebug('Download falhou: ' + err.message + ' (CORS ou prote√ß√£o no servidor)', 'err');
    alert("Download falhou.\nProv√°vel CORS bloqueado ou link protegido.\nUse .mp4 direto sem prote√ß√£o.");
  }
}

// ‚îÄ‚îÄ‚îÄ Start ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
initPeer(SLOT_A, SLOT_B);
logDebug('SyncWatch iniciado. Cole um link MP4 direto (sem CORS bloqueado) pra funcionar pros dois.');
</script>
</body>
</html>
