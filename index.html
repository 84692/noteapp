<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SyncWatch</title>
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#080810;--surface:#0f0f18;--card:#14141f;--border:#252535;
    --accent:#e8ff47;--accent2:#7c5cfc;--green:#3ddc84;--red:#ff4757;
    --orange:#f5a623;--text:#ececf0;--muted:#5a5a72;--r:8px;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh;}
  body::after{
    content:'';position:fixed;inset:0;pointer-events:none;z-index:0;opacity:.14;
    background-image:linear-gradient(var(--border) 1px,transparent 1px),linear-gradient(90deg,var(--border) 1px,transparent 1px);
    background-size:48px 48px;
  }
  header{
    position:relative;z-index:10;padding:1.2rem 2rem;display:flex;align-items:center;gap:1rem;
    border-bottom:1px solid var(--border);background:rgba(8,8,16,.85);backdrop-filter:blur(12px);
  }
  .logo{font-family:'Bebas Neue',sans-serif;font-size:1.9rem;letter-spacing:3px;color:var(--accent);}
  .logo span{color:var(--text);}
  .pill{
    margin-left:auto;display:flex;align-items:center;gap:.5rem;
    background:var(--card);border:1px solid var(--border);
    padding:.35rem .9rem;border-radius:999px;font-size:.78rem;color:var(--muted);transition:all .4s;
  }
  .dot{width:7px;height:7px;border-radius:50%;background:var(--muted);transition:all .4s;flex-shrink:0;}
  .pill.connecting .dot{background:var(--orange);box-shadow:0 0 6px var(--orange);}
  .pill.connected  .dot{background:var(--green);box-shadow:0 0 8px var(--green);animation:blink 2.5s infinite;}
  .pill.connected{border-color:rgba(61,220,132,.25);color:var(--text);}
  .pill.proxying  .dot{background:var(--accent);box-shadow:0 0 8px var(--accent);animation:blink .8s infinite;}
  .pill.proxying{border-color:rgba(232,255,71,.25);color:var(--accent);}
  .pill.error .dot{background:var(--red);}
  @keyframes blink{0%,100%{opacity:1}50%{opacity:.35}}

  .wrap{
    position:relative;z-index:5;max-width:900px;margin:0 auto;
    padding:1.8rem 1.5rem;display:flex;flex-direction:column;gap:1.2rem;
  }
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:1.2rem 1.4rem;}
  .lbl{font-size:.68rem;font-weight:500;letter-spacing:.14em;text-transform:uppercase;color:var(--muted);margin-bottom:.65rem;}
  .row{display:flex;gap:.7rem;align-items:stretch;}

  input{
    flex:1;background:var(--surface);border:1px solid var(--border);color:var(--text);
    padding:.7rem 1rem;border-radius:var(--r);font-family:inherit;font-size:.88rem;outline:none;
    transition:border-color .2s,box-shadow .2s;
  }
  input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(232,255,71,.07);}
  input::placeholder{color:var(--muted);font-style:italic;}

  button{
    background:var(--accent);color:#080810;border:none;padding:.7rem 1.4rem;border-radius:var(--r);
    font-family:inherit;font-weight:600;font-size:.85rem;cursor:pointer;transition:all .18s;
    white-space:nowrap;display:inline-flex;align-items:center;gap:.4rem;
  }
  button:hover{background:#d4eb00;transform:translateY(-1px);}
  button:active{transform:translateY(0);}
  button.ghost{background:var(--surface);color:var(--text);border:1px solid var(--border);font-weight:400;}
  button.ghost:hover{border-color:var(--accent);color:var(--accent);}

  .share-row{
    margin-top:.8rem;padding-top:.8rem;border-top:1px solid var(--border);
    display:flex;gap:.7rem;align-items:center;
  }
  .share-url{
    flex:1;font-family:'Courier New',monospace;font-size:.75rem;color:var(--muted);
    background:var(--surface);border:1px solid var(--border);padding:.55rem .9rem;
    border-radius:var(--r);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;user-select:all;
  }
  .copied{font-size:.75rem;color:var(--green);opacity:0;transition:opacity .3s;pointer-events:none;}
  .copied.show{opacity:1;}

  .log{font-size:.78rem;color:var(--muted);font-style:italic;min-height:1.2rem;transition:color .3s;}
  .log.ok{color:var(--green);font-style:normal;}
  .log.err{color:var(--red);font-style:normal;}
  .log.info{color:var(--accent);font-style:normal;}

  .proxy-card{
    display:none;background:rgba(232,255,71,.04);
    border:1px solid rgba(232,255,71,.15);border-radius:var(--r);padding:1rem 1.2rem;
  }
  .proxy-card.show{display:block;}
  .proxy-card .title{font-size:.8rem;font-weight:600;color:var(--accent);margin-bottom:.6rem;}
  .proxy-steps{display:flex;flex-direction:column;gap:.3rem;margin-bottom:.7rem;}
  .step{font-size:.75rem;color:var(--muted);display:flex;align-items:center;gap:.5rem;}
  .step.active{color:var(--text);}
  .step.done{color:var(--green);}
  .step.fail{color:var(--red);}
  .pbar-wrap{height:4px;background:var(--border);border-radius:2px;overflow:hidden;}
  .pbar{height:100%;background:var(--accent);width:0%;transition:width .2s;border-radius:2px;}
  .pbar-label{font-size:.72rem;color:var(--muted);margin-top:.4rem;}

  /* receiver progress */
  .recv-card{
    display:none;background:rgba(124,92,252,.05);
    border:1px solid rgba(124,92,252,.2);border-radius:var(--r);padding:1rem 1.2rem;
  }
  .recv-card.show{display:block;}
  .recv-card .title{font-size:.8rem;font-weight:600;color:var(--accent2);margin-bottom:.5rem;}
  .recv-pbar-wrap{height:4px;background:var(--border);border-radius:2px;overflow:hidden;margin-top:.5rem;}
  .recv-pbar{height:100%;background:var(--accent2);width:0%;transition:width .3s;border-radius:2px;}
  .recv-label{font-size:.72rem;color:var(--muted);margin-top:.4rem;}

  .vwrap{
    position:relative;background:#000;border-radius:var(--r);
    overflow:hidden;aspect-ratio:16/9;border:1px solid var(--border);
  }
  video{width:100%;height:100%;display:block;background:#000;}
  .placeholder{
    position:absolute;inset:0;display:flex;flex-direction:column;
    align-items:center;justify-content:center;gap:1rem;background:var(--surface);
  }
  .placeholder .icon{font-size:3.5rem;opacity:.1;}
  .placeholder p{color:var(--muted);font-size:.88rem;text-align:center;padding:0 2rem;}
  .toast{
    position:absolute;top:.9rem;right:.9rem;background:rgba(8,8,16,.9);
    border:1px solid var(--border);backdrop-filter:blur(10px);
    padding:.4rem .9rem;border-radius:999px;font-size:.72rem;color:var(--accent);
    opacity:0;transform:translateY(-4px);transition:all .3s;pointer-events:none;
  }
  .toast.show{opacity:1;transform:translateY(0);}

  .peers-bar{display:flex;align-items:center;gap:1rem;flex-wrap:wrap;}
  .avatar-row{display:flex;}
  .av{
    width:30px;height:30px;border-radius:50%;border:2px solid var(--bg);
    display:flex;align-items:center;justify-content:center;
    font-size:.75rem;font-weight:600;margin-left:-4px;
  }
  .av:first-child{margin-left:0;}
  .av.me{background:var(--accent);color:#000;}
  .av.p1{background:var(--accent2);color:#fff;}
  .peers-info{flex:1;}
  .peers-info strong{display:block;font-size:.83rem;}
  .peers-info small{font-size:.73rem;color:var(--muted);}
  .badge{padding:.28rem .75rem;border-radius:999px;background:var(--surface);border:1px solid var(--border);font-size:.75rem;color:var(--muted);}
  .badge span{color:var(--accent);font-weight:600;}

  footer{
    position:relative;z-index:5;text-align:center;
    padding:1.5rem;color:var(--muted);font-size:.72rem;border-top:1px solid var(--border);
  }
</style>
</head>
<body>

<header>
  <div class="logo">Sync<span>Watch</span></div>
  <div class="pill" id="pill"><div class="dot"></div><span id="pillTxt">Iniciandoâ€¦</span></div>
</header>

<div class="wrap">

  <div class="card">
    <div class="lbl">ðŸŽ¬ Link do vÃ­deo</div>
    <div class="row">
      <input id="vurl" type="text" placeholder="Cole o link direto (.mp4, .m3u8, googlevideo, etc)â€¦"/>
      <button onclick="loadAndBroadcast()">â–¶ Carregar</button>
    </div>
  </div>

  <!-- sender progress -->
  <div class="proxy-card" id="proxyCard">
    <div class="title">ðŸ“¡ TransmissÃ£o proxy â†’ parceiro</div>
    <div class="proxy-steps" id="proxySteps"></div>
    <div class="pbar-wrap"><div class="pbar" id="pbar"></div></div>
    <div class="pbar-label" id="pbarLabel">Aguardandoâ€¦</div>
  </div>

  <!-- receiver progress -->
  <div class="recv-card" id="recvCard">
    <div class="title">ðŸ“º Recebendo vÃ­deo do parceiroâ€¦</div>
    <div class="recv-pbar-wrap"><div class="recv-pbar" id="recvPbar"></div></div>
    <div class="recv-label" id="recvLabel">Aguardando dadosâ€¦</div>
  </div>

  <div class="card">
    <div class="lbl">ðŸ”— Compartilhar sala</div>
    <div id="log" class="log">Gerando sala P2Pâ€¦</div>
    <div class="share-row">
      <div class="share-url" id="shareUrl">aguardandoâ€¦</div>
      <button class="ghost" onclick="copyLink()">Copiar link</button>
      <span class="copied" id="copied">âœ“ Copiado!</span>
    </div>
  </div>

  <div class="vwrap">
    <div class="placeholder" id="ph">
      <div class="icon">â–¶</div>
      <p>Cole um link de vÃ­deo acima e clique em Carregar</p>
    </div>
    <video id="vid" controls style="display:none"></video>
    <div class="toast" id="toast"></div>
  </div>

  <div class="card">
    <div class="peers-bar">
      <div class="avatar-row" id="avatarRow"><div class="av me">V</div></div>
      <div class="peers-info">
        <strong id="peerTitle">Sala pronta</strong>
        <small id="peerSub">Aguardando outra pessoaâ€¦</small>
      </div>
      <div class="badge">Na sala: <span id="peerN">1</span></div>
    </div>
  </div>

</div>

<footer>SyncWatch Â· WebRTC P2P Â· proxy CORS automÃ¡tico Â· sem servidor</footer>

<script>
'use strict';

// â”€â”€ Room â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getRoom(){let h=location.hash.slice(1);if(!h){h=Math.random().toString(36).slice(2,9);location.hash=h;}return h;}
const ROOM=getRoom(),SLOT_A='sw-'+ROOM+'-a',SLOT_B='sw-'+ROOM+'-b',SHARE=location.href;
document.getElementById('shareUrl').textContent=SHARE;

// â”€â”€ CORS proxy chain â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PROXIES=[
  u=>`https://corsproxy.io/?url=${encodeURIComponent(u)}`,
  u=>`https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
  u=>`https://cors-anywhere.herokuapp.com/${u}`,
  u=>`https://thingproxy.freeboard.io/fetch/${u}`,
  u=>u,
];

async function fetchViaProxy(url, signal){
  for(let i=0;i<PROXIES.length;i++){
    const pu=PROXIES[i](url);
    addStep(`â¬‡ï¸ Tentando ${i===PROXIES.length-1?'direto':'proxy '+(i+1)}â€¦`,'active');
    try{
      const r=await fetch(pu,{signal,credentials:'omit'});
      if(!r.ok) throw new Error('HTTP '+r.status);
      updateLastStep(`âœ… Conectado via ${i===PROXIES.length-1?'direto':'proxy '+(i+1)}`,'done');
      return r;
    }catch(e){
      if(e.name==='AbortError') throw e;
      updateLastStep(`âŒ ${i===PROXIES.length-1?'Direto':'Proxy '+(i+1)} falhou`,'fail');
      await new Promise(r=>setTimeout(r,250));
    }
  }
  throw new Error('Todos os proxies falharam');
}

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const vid=document.getElementById('vid');
let peer,conn,mySlot,theirSlot,retryTimer;
let ignoring=false,hls=null,fetchCtrl=null;

// receiver MSE state
let ms=null, sb=null, queue=[], sbBusy=false, recvBytes=0;

// â”€â”€ UI helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setPill(cls,txt){document.getElementById('pill').className='pill '+cls;document.getElementById('pillTxt').textContent=txt;}
let toastT;
function showToast(m){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');clearTimeout(toastT);toastT=setTimeout(()=>t.classList.remove('show'),2500);}
function setLog(m,c=''){const l=document.getElementById('log');l.textContent=m;l.className='log '+c;}

function addStep(txt,cls){
  const d=document.createElement('div');d.className='step '+(cls||'');
  d.textContent=txt;document.getElementById('proxySteps').appendChild(d);
}
function updateLastStep(txt,cls){
  const steps=document.getElementById('proxySteps').children;
  if(!steps.length)return;
  const last=steps[steps.length-1];
  last.textContent=txt;last.className='step '+(cls||'');
}
function setProgress(pct,label){
  document.getElementById('pbar').style.width=Math.min(100,pct)+'%';
  document.getElementById('pbarLabel').textContent=label;
}
function setRecvProgress(pct,label){
  document.getElementById('recvPbar').style.width=Math.min(100,pct)+'%';
  document.getElementById('recvLabel').textContent=label;
}
function setConnected(yes){
  document.getElementById('peerN').textContent=yes?2:1;
  document.getElementById('peerTitle').textContent=yes?'2 pessoas â€” sincronizados!':'Sala pronta';
  document.getElementById('peerSub').textContent=yes?'ConexÃ£o WebRTC direta âœ“':'Aguardando outra pessoaâ€¦';
  const row=document.getElementById('avatarRow'),ex=row.querySelector('.p1');
  if(yes&&!ex){const a=document.createElement('div');a.className='av p1';a.textContent='P';row.appendChild(a);}
  else if(!yes&&ex)ex.remove();
  if(yes)setPill('connected','Conectado âœ“');
  else setPill('connecting','Aguardandoâ€¦');
}

// â”€â”€ PeerJS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initPeer(slot,fallback){
  setLog('Conectando ao servidor de sinalizaÃ§Ã£oâ€¦');setPill('connecting','Conectandoâ€¦');
  peer=new Peer(slot,{
    host:'0.peerjs.com',port:443,path:'/',secure:true,debug:0,
    config:{iceServers:[{urls:'stun:stun.l.google.com:19302'},{urls:'stun:stun1.l.google.com:19302'}]}
  });
  peer.on('open',id=>{
    mySlot=id;theirSlot=id===SLOT_A?SLOT_B:SLOT_A;
    setLog('Sala pronta Â· aguardando parceiroâ€¦','ok');
    setPill('connecting','Aguardando parceiroâ€¦');
    attemptConnect(theirSlot);
  });
  peer.on('connection',c=>setupConn(c));
  peer.on('error',err=>{
    if(err.type==='unavailable-id'&&fallback){peer.destroy();initPeer(fallback,null);return;}
    if(err.type==='peer-unavailable'){clearTimeout(retryTimer);retryTimer=setTimeout(()=>attemptConnect(theirSlot),4000);return;}
    setLog('Erro: '+err.type,'err');setPill('error','Erro');
  });
  peer.on('disconnected',()=>peer.reconnect());
}
function attemptConnect(t){if(conn&&conn.open)return;setupConn(peer.connect(t,{reliable:true,serialization:'binary'}));}
function setupConn(c){
  c.on('open',()=>{
    conn=c;clearTimeout(retryTimer);setConnected(true);setLog('ConexÃ£o P2P estabelecida!','ok');
    const url=document.getElementById('vurl').value.trim();
    if(url) setTimeout(()=>syncToPartner(url,false),400);
  });
  c.on('data',onData);
  c.on('close',()=>{conn=null;setConnected(false);setLog('Parceiro desconectou.','err');clearTimeout(retryTimer);retryTimer=setTimeout(()=>attemptConnect(theirSlot),3000);});
  c.on('error',e=>setLog('Erro de conexÃ£o: '+e,'err'));
}

// â”€â”€ Binary framing (0x01=json, 0x02=video chunk) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEC=new TextDecoder();
function sendMsg(obj){
  if(!conn?.open)return;
  const j=JSON.stringify(obj),b=new Uint8Array(j.length+1);
  b[0]=0x01;for(let i=0;i<j.length;i++)b[i+1]=j.charCodeAt(i);
  conn.send(b.buffer);
}
function sendChunk(ab){
  if(!conn?.open)return;
  const s=new Uint8Array(ab),o=new Uint8Array(s.length+1);
  o[0]=0x02;o.set(s,1);conn.send(o.buffer);
}
function onData(raw){
  const arr=raw instanceof ArrayBuffer?new Uint8Array(raw):raw instanceof Uint8Array?raw:null;
  if(!arr){try{handleMsg(typeof raw==='string'?JSON.parse(raw):raw);}catch(e){}return;}
  if(arr[0]===0x01)try{handleMsg(JSON.parse(DEC.decode(arr.slice(1))));}catch(e){console.error(e);}
  else if(arr[0]===0x02)handleChunk(arr.slice(1).buffer);
}

// â”€â”€ Control messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleMsg(msg){
  if(!msg?.type)return;

  if(msg.type==='load'){
    ignoring=true;
    loadVideo(msg.url);
    document.getElementById('vurl').value=msg.url;
    showToast('ðŸŽ¬ Parceiro carregou vÃ­deo');
    setTimeout(()=>{if(typeof msg.currentTime==='number')vid.currentTime=msg.currentTime;if(!msg.paused)vid.play().catch(()=>{});ignoring=false;},900);
    return;
  }

  // â”€â”€ proxy_ready: sent AFTER sender confirmed fetch works, with real mime â”€â”€
  if(msg.type==='proxy_ready'){
    document.getElementById('recvCard').classList.add('show');
    document.getElementById('ph').style.display='none';
    vid.style.display='block';
    setLog('Recebendo vÃ­deo via WebRTCâ€¦','info');
    showToast('ðŸ“º Recebendo stream do parceiroâ€¦');
    initReceiver(msg.mime, msg.totalBytes||0);
    return;
  }

  if(msg.type==='proxy_done'){
    showToast('âœ… Stream recebido!');
    setLog('VÃ­deo recebido com sucesso!','ok');
    endReceiver();
    return;
  }

  if(msg.type==='proxy_error'){
    setLog('Erro no proxy: '+msg.msg,'err');
    showToast('âŒ Erro: '+msg.msg);
    return;
  }

  // playback sync
  ignoring=true;
  if(msg.type==='play'){
    const drift=(Date.now()-msg.ts)/1000,t=msg.currentTime+drift;
    if(Math.abs(vid.currentTime-t)>1.5)vid.currentTime=t;
    vid.play().catch(()=>{});showToast('â–¶ Parceiro deu play');
  }else if(msg.type==='pause'){
    vid.pause();
    if(Math.abs(vid.currentTime-msg.currentTime)>1)vid.currentTime=msg.currentTime;
    showToast('â¸ Parceiro pausou');
  }else if(msg.type==='seek'){
    vid.currentTime=msg.currentTime;showToast('â© Parceiro avanÃ§ou');
  }
  setTimeout(()=>{ignoring=false;},400);
}

// â”€â”€ SENDER: fetch + stream â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startProxy(url){
  document.getElementById('proxyCard').classList.add('show');
  document.getElementById('proxySteps').innerHTML='';
  setPill('proxying','Transmitindoâ€¦');
  fetchCtrl=new AbortController();

  addStep('ðŸ” Link IP-locked detectado','done');

  let resp;
  try{
    resp=await fetchViaProxy(url, fetchCtrl.signal);
  }catch(e){
    if(e.name==='AbortError')return;
    sendMsg({type:'proxy_error',msg:'Fetch falhou: '+e.message});
    setLog('Falha no fetch: '+e.message,'err');
    setPill('connected','Conectado');
    return;
  }

  // Detect actual mime from Content-Type header
  const ct=(resp.headers.get('content-type')||'video/mp4').split(';')[0].trim();
  const totalBytes=parseInt(resp.headers.get('content-length')||'0');

  // Pick a mime+codec string the receiver's MSE can use
  let mime;
  if(ct==='video/webm'||ct==='video/webm'){
    mime='video/webm; codecs="vp8, vorbis"';
  }else{
    // Default: mp4. Try fancier codec strings first.
    mime='video/mp4; codecs="avc1.42E01E, mp4a.40.2"';
  }

  // Tell receiver to set up MSE with the real mime + expected size
  sendMsg({type:'proxy_ready', mime, totalBytes});

  // Give receiver 300ms to set up MediaSource before chunks start flying
  await new Promise(r=>setTimeout(r,300));

  addStep('ðŸ“¤ Enviando chunks via WebRTCâ€¦','active');
  const reader=resp.body.getReader();
  let received=0;

  while(true){
    let value,done;
    try{{({value,done}=await reader.read());}
    }catch(e){break;}
    if(done)break;
    sendChunk(value.buffer);
    received+=value.length;
    const mb=(received/1024/1024).toFixed(1);
    const pct=totalBytes>0?(received/totalBytes*100):0;
    setProgress(pct, `${mb} MB${totalBytes>0?' / '+(totalBytes/1024/1024).toFixed(1)+' MB':''} enviados`);
  }

  sendMsg({type:'proxy_done'});
  updateLastStep('âœ… TransmissÃ£o completa!','done');
  setProgress(100,'Completo âœ“');
  setPill('connected','Conectado âœ“');
}

// â”€â”€ RECEIVER: MediaSource + SourceBuffer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initReceiver(mime, totalBytes){
  // clean up any previous
  if(ms){try{if(ms.readyState==='open')ms.endOfStream();}catch(e){}}
  ms=null;sb=null;queue=[];sbBusy=false;recvBytes=0;

  // Find a supported mime
  const candidates=[
    mime,
    'video/mp4; codecs="avc1.42E01E, mp4a.40.2"',
    'video/mp4; codecs="avc1.640028, mp4a.40.2"',
    'video/mp4; codecs="avc1.4d401e, mp4a.40.2"',
    'video/mp4',
    'video/webm; codecs="vp8, vorbis"',
    'video/webm; codecs="vp9"',
    'video/webm',
  ];
  const supportedMime=candidates.find(m=>{
    try{return MediaSource.isTypeSupported(m);}catch(e){return false;}
  });

  if(!supportedMime){
    setLog('Nenhum codec suportado pelo navegador!','err');
    return;
  }

  ms=new MediaSource();
  const objectUrl=URL.createObjectURL(ms);
  vid.src=objectUrl;

  ms.addEventListener('sourceopen',()=>{
    URL.revokeObjectURL(objectUrl); // clean up blob URL
    try{
      sb=ms.addSourceBuffer(supportedMime);
      sb.mode='sequence'; // crucial: append in order, no timestamps needed
      sb.addEventListener('updateend',()=>{
        sbBusy=false;
        drainQueue(totalBytes);
      });
      drainQueue(totalBytes);
    }catch(e){
      setLog('SourceBuffer erro: '+e.message+' (mime: '+supportedMime+')','err');
      console.error('SourceBuffer error:',e,supportedMime);
    }
  },{once:true});

  ms.addEventListener('sourceclose',()=>{console.log('MSE sourceclose');});
  ms.addEventListener('sourceerror',e=>{console.error('MSE error:',e);});
}

function handleChunk(ab){
  queue.push(ab);
  recvBytes+=ab.byteLength;
  setRecvProgress(0, (recvBytes/1024/1024).toFixed(1)+' MB recebidosâ€¦');
  if(sb&&!sbBusy)drainQueue(0);
}

function drainQueue(totalBytes){
  if(!sb||sbBusy||queue.length===0)return;
  if(!ms||ms.readyState!=='open')return;
  sbBusy=true;
  try{
    sb.appendBuffer(queue.shift());
    // auto-play once we have enough data
    if(vid.paused&&vid.readyState>=2){
      vid.play().catch(()=>{});
    }
  }catch(e){
    sbBusy=false;
    if(e.name==='QuotaExceededError'){
      // Remove old data to free space
      if(vid.currentTime>10){
        try{
          sb.remove(0, vid.currentTime-5);
          // put chunk back and retry after remove
          queue.unshift(/*re-add*/new ArrayBuffer(0)); // placeholder cleared on updateend
        }catch(e2){}
      }
    }else{
      console.error('appendBuffer error:',e);
      setLog('Erro append: '+e.message,'err');
    }
  }
}

function endReceiver(){
  if(!ms||ms.readyState!=='open')return;
  const finish=()=>{
    try{ms.endOfStream();}catch(e){console.warn('endOfStream:',e);}
  };
  if(sb&&sb.updating){
    sb.addEventListener('updateend',finish,{once:true});
  }else if(queue.length===0){
    finish();
  }else{
    // wait for queue to drain
    const check=setInterval(()=>{if(queue.length===0){clearInterval(check);finish();}},100);
  }
}

// â”€â”€ Player events â†’ sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
vid.addEventListener('play',()=>{if(!ignoring)sendMsg({type:'play',currentTime:vid.currentTime,ts:Date.now()});});
vid.addEventListener('pause',()=>{if(!ignoring)sendMsg({type:'pause',currentTime:vid.currentTime});});
let lastSeek=0;
vid.addEventListener('seeked',()=>{
  if(ignoring)return;const n=Date.now();if(n-lastSeek<500)return;lastSeek=n;
  sendMsg({type:'seek',currentTime:vid.currentTime});
});

// â”€â”€ Load video (local / normal URLs) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadVideo(url){
  if(hls){hls.destroy();hls=null;}
  document.getElementById('ph').style.display='none';
  vid.style.display='block';
  if(/\.m3u8/i.test(url)||/m3u8/i.test(url)){
    if(Hls.isSupported()){hls=new Hls({enableWorker:false});hls.loadSource(url);hls.attachMedia(vid);}
    else if(vid.canPlayType('application/vnd.apple.mpegurl'))vid.src=url;
    else setLog('HLS nÃ£o suportado.','err');
  }else{
    vid.src=url;
  }
}

function isIpLocked(url){
  return /googlevideo\.com/.test(url)&&/[?&]ip=/.test(url);
}

function syncToPartner(url,isNewLoad){
  if(!conn?.open)return;
  if(isIpLocked(url)){
    startProxy(url);
  }else{
    sendMsg({type:'load',url,currentTime:isNewLoad?0:vid.currentTime,paused:!isNewLoad||vid.paused});
  }
}

function loadAndBroadcast(){
  const url=document.getElementById('vurl').value.trim();
  if(!url)return;
  loadVideo(url);
  syncToPartner(url,true);
}

document.getElementById('vurl').addEventListener('keydown',e=>{if(e.key==='Enter')loadAndBroadcast();});

// â”€â”€ Copy link â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function copyLink(){
  navigator.clipboard.writeText(SHARE).then(()=>{
    const c=document.getElementById('copied');c.classList.add('show');setTimeout(()=>c.classList.remove('show'),2000);
  });
}

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
initPeer(SLOT_A,SLOT_B);
</script>
</body>
</html>
