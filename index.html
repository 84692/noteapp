<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SyncWatch</title>
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#080810;--surface:#0f0f18;--card:#14141f;--border:#252535;
    --accent:#e8ff47;--accent2:#7c5cfc;--green:#3ddc84;--red:#ff4757;
    --orange:#f5a623;--text:#ececf0;--muted:#5a5a72;--r:8px;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh;}
  body::after{
    content:'';position:fixed;inset:0;pointer-events:none;z-index:0;opacity:.14;
    background-image:linear-gradient(var(--border) 1px,transparent 1px),linear-gradient(90deg,var(--border) 1px,transparent 1px);
    background-size:48px 48px;
  }
  header{
    position:relative;z-index:10;padding:1.2rem 2rem;display:flex;align-items:center;gap:1rem;
    border-bottom:1px solid var(--border);background:rgba(8,8,16,.85);backdrop-filter:blur(12px);
  }
  .logo{font-family:'Bebas Neue',sans-serif;font-size:1.9rem;letter-spacing:3px;color:var(--accent);}
  .logo span{color:var(--text);}
  .pill{
    margin-left:auto;display:flex;align-items:center;gap:.5rem;
    background:var(--card);border:1px solid var(--border);
    padding:.35rem .9rem;border-radius:999px;font-size:.78rem;color:var(--muted);transition:all .4s;
  }
  .dot{width:7px;height:7px;border-radius:50%;background:var(--muted);transition:all .4s;flex-shrink:0;}
  .pill.connecting .dot{background:var(--orange);box-shadow:0 0 6px var(--orange);}
  .pill.connected .dot{background:var(--green);box-shadow:0 0 8px var(--green);animation:blink 2.5s infinite;}
  .pill.connected{border-color:rgba(61,220,132,.25);color:var(--text);}
  .pill.proxying .dot{background:var(--accent);box-shadow:0 0 8px var(--accent);animation:blink .8s infinite;}
  .pill.proxying{border-color:rgba(232,255,71,.25);color:var(--accent);}
  .pill.error .dot{background:var(--red);}
  @keyframes blink{0%,100%{opacity:1}50%{opacity:.35}}

  .wrap{
    position:relative;z-index:5;max-width:900px;margin:0 auto;
    padding:1.8rem 1.5rem;display:flex;flex-direction:column;gap:1.2rem;
  }
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:1.2rem 1.4rem;}
  .lbl{font-size:.68rem;font-weight:500;letter-spacing:.14em;text-transform:uppercase;color:var(--muted);margin-bottom:.65rem;}
  .row{display:flex;gap:.7rem;align-items:stretch;}

  input{
    flex:1;background:var(--surface);border:1px solid var(--border);color:var(--text);
    padding:.7rem 1rem;border-radius:var(--r);font-family:inherit;font-size:.88rem;outline:none;
    transition:border-color .2s,box-shadow .2s;
  }
  input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(232,255,71,.07);}
  input::placeholder{color:var(--muted);font-style:italic;}

  button{
    background:var(--accent);color:#080810;border:none;padding:.7rem 1.4rem;border-radius:var(--r);
    font-family:inherit;font-weight:600;font-size:.85rem;cursor:pointer;transition:all .18s;
    white-space:nowrap;display:inline-flex;align-items:center;gap:.4rem;
  }
  button:hover{background:#d4eb00;transform:translateY(-1px);}
  button:active{transform:translateY(0);}
  button.ghost{background:var(--surface);color:var(--text);border:1px solid var(--border);font-weight:400;}
  button.ghost:hover{border-color:var(--accent);color:var(--accent);}
  button:disabled{opacity:.35;cursor:not-allowed;transform:none!important;}

  .share-row{
    margin-top:.8rem;padding-top:.8rem;border-top:1px solid var(--border);
    display:flex;gap:.7rem;align-items:center;
  }
  .share-url{
    flex:1;font-family:'Courier New',monospace;font-size:.75rem;color:var(--muted);
    background:var(--surface);border:1px solid var(--border);padding:.55rem .9rem;
    border-radius:var(--r);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;user-select:all;
  }
  .copied{font-size:.75rem;color:var(--green);opacity:0;transition:opacity .3s;pointer-events:none;}
  .copied.show{opacity:1;}

  /* status log with steps */
  .log{font-size:.78rem;color:var(--muted);font-style:italic;min-height:1.2rem;transition:color .3s;}
  .log.ok{color:var(--green);font-style:normal;}
  .log.err{color:var(--red);font-style:normal;}
  .log.info{color:var(--accent);font-style:normal;}

  /* proxy progress card */
  .proxy-card{
    display:none;background:rgba(232,255,71,.04);
    border:1px solid rgba(232,255,71,.15);border-radius:var(--r);padding:1rem 1.2rem;
  }
  .proxy-card.show{display:block;}
  .proxy-card .title{font-size:.8rem;font-weight:600;color:var(--accent);margin-bottom:.6rem;}
  .proxy-steps{display:flex;flex-direction:column;gap:.3rem;margin-bottom:.7rem;}
  .step{font-size:.75rem;color:var(--muted);display:flex;align-items:center;gap:.5rem;}
  .step.active{color:var(--text);}
  .step.done{color:var(--green);}
  .step.fail{color:var(--red);}
  .step-icon{font-size:.8rem;width:1.1rem;text-align:center;}
  .pbar-wrap{height:4px;background:var(--border);border-radius:2px;overflow:hidden;}
  .pbar{height:100%;background:var(--accent);width:0%;transition:width .2s;border-radius:2px;}
  .pbar-label{font-size:.72rem;color:var(--muted);margin-top:.4rem;}

  /* video */
  .vwrap{
    position:relative;background:#000;border-radius:var(--r);
    overflow:hidden;aspect-ratio:16/9;border:1px solid var(--border);
  }
  video{width:100%;height:100%;display:block;background:#000;}
  .placeholder{
    position:absolute;inset:0;display:flex;flex-direction:column;
    align-items:center;justify-content:center;gap:1rem;background:var(--surface);
  }
  .placeholder .icon{font-size:3.5rem;opacity:.1;}
  .placeholder p{color:var(--muted);font-size:.88rem;}
  .toast{
    position:absolute;top:.9rem;right:.9rem;background:rgba(8,8,16,.9);
    border:1px solid var(--border);backdrop-filter:blur(10px);
    padding:.4rem .9rem;border-radius:999px;font-size:.72rem;color:var(--accent);
    opacity:0;transform:translateY(-4px);transition:all .3s;pointer-events:none;
  }
  .toast.show{opacity:1;transform:translateY(0);}

  /* peers */
  .peers-bar{display:flex;align-items:center;gap:1rem;flex-wrap:wrap;}
  .avatar-row{display:flex;}
  .av{
    width:30px;height:30px;border-radius:50%;border:2px solid var(--bg);
    display:flex;align-items:center;justify-content:center;
    font-size:.75rem;font-weight:600;margin-left:-4px;
  }
  .av:first-child{margin-left:0;}
  .av.me{background:var(--accent);color:#000;}
  .av.p1{background:var(--accent2);color:#fff;}
  .peers-info{flex:1;}
  .peers-info strong{display:block;font-size:.83rem;}
  .peers-info small{font-size:.73rem;color:var(--muted);}
  .badge{padding:.28rem .75rem;border-radius:999px;background:var(--surface);border:1px solid var(--border);font-size:.75rem;color:var(--muted);}
  .badge span{color:var(--accent);font-weight:600;}

  footer{
    position:relative;z-index:5;text-align:center;
    padding:1.5rem;color:var(--muted);font-size:.72rem;border-top:1px solid var(--border);
  }
</style>
</head>
<body>

<header>
  <div class="logo">Sync<span>Watch</span></div>
  <div class="pill" id="pill"><div class="dot"></div><span id="pillTxt">Iniciandoâ€¦</span></div>
</header>

<div class="wrap">

  <div class="card">
    <div class="lbl">ğŸ¬ Link do vÃ­deo</div>
    <div class="row">
      <input id="vurl" type="text" placeholder="Cole o link direto (.mp4, .m3u8, googlevideo, etc)â€¦"/>
      <button id="loadBtn" onclick="loadAndBroadcast()">â–¶ Carregar</button>
    </div>
  </div>

  <!-- proxy progress -->
  <div class="proxy-card" id="proxyCard">
    <div class="title">ğŸ“¡ TransmissÃ£o proxy para o parceiro</div>
    <div class="proxy-steps" id="proxySteps">
      <div class="step" id="step-detect"><span class="step-icon">ğŸ”</span>Detectando tipo de linkâ€¦</div>
      <div class="step" id="step-fetch"><span class="step-icon">â¬‡ï¸</span>Buscando vÃ­deo (fetch direto)â€¦</div>
      <div class="step" id="step-send"><span class="step-icon">ğŸ“¤</span>Enviando para parceiro via WebRTCâ€¦</div>
    </div>
    <div class="pbar-wrap"><div class="pbar" id="pbar"></div></div>
    <div class="pbar-label" id="pbarLabel">0 MB transferidos</div>
  </div>

  <div class="card">
    <div class="lbl">ğŸ”— Compartilhar sala</div>
    <div id="log" class="log">Gerando sala P2Pâ€¦</div>
    <div class="share-row">
      <div class="share-url" id="shareUrl">aguardandoâ€¦</div>
      <button class="ghost" onclick="copyLink()">Copiar link</button>
      <span class="copied" id="copied">âœ“ Copiado!</span>
    </div>
  </div>

  <div class="vwrap">
    <div class="placeholder" id="ph">
      <div class="icon">â–¶</div>
      <p>Cole um link de vÃ­deo acima e clique em Carregar</p>
    </div>
    <video id="vid" controls style="display:none"></video>
    <div class="toast" id="toast"></div>
  </div>

  <div class="card">
    <div class="peers-bar">
      <div class="avatar-row" id="avatarRow"><div class="av me">V</div></div>
      <div class="peers-info">
        <strong id="peerTitle">Sala pronta</strong>
        <small id="peerSub">Aguardando outra pessoaâ€¦</small>
      </div>
      <div class="badge">Na sala: <span id="peerN">1</span></div>
    </div>
  </div>

</div>

<footer>SyncWatch Â· WebRTC P2P Â· proxy com fallback CORS Â· sem servidor</footer>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROOM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getRoom(){let h=location.hash.slice(1);if(!h){h=Math.random().toString(36).slice(2,9);location.hash=h;}return h;}
const ROOM=getRoom(),SLOT_A='sw-'+ROOM+'-a',SLOT_B='sw-'+ROOM+'-b',SHARE=location.href;
document.getElementById('shareUrl').textContent=SHARE;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CORS PROXY CHAIN â€” tried in order until one works
// These are public CORS proxies; if one dies, next is tried
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CORS_PROXIES=[
  url=>`https://corsproxy.io/?url=${encodeURIComponent(url)}`,
  url=>`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
  url=>`https://cors-anywhere.herokuapp.com/${url}`,
  url=>`https://thingproxy.freeboard.io/fetch/${url}`,
  url=>url, // last resort: try direct (might work if server allows CORS)
];

async function fetchWithCorsProxy(url,onProgress){
  let lastErr=null;
  for(let i=0;i<CORS_PROXIES.length;i++){
    const proxyUrl=CORS_PROXIES[i](url);
    const label=i===CORS_PROXIES.length-1?'direto':`proxy ${i+1}`;
    setStep('fetch',`â¬‡ï¸ Tentando ${label}â€¦`,'active');
    try{
      const resp=await fetch(proxyUrl,{signal:fetchCtrl.signal,credentials:'omit'});
      if(!resp.ok)throw new Error(`HTTP ${resp.status}`);
      // Success â€” stream it
      setStep('fetch',`â¬‡ï¸ Conectado via ${label}!`,'done');
      return resp;
    }catch(e){
      if(e.name==='AbortError')throw e;
      lastErr=e;
      setStep('fetch',`â¬‡ï¸ ${label} falhou, tentando prÃ³ximoâ€¦`,'fail');
      await sleep(300);
    }
  }
  throw new Error('Todos os proxies falharam: '+lastErr?.message);
}

const sleep=ms=>new Promise(r=>setTimeout(r,ms));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const vid=document.getElementById('vid');
let peer,conn,mySlot,theirSlot,retryTimer;
let ignoring=false,hls=null;
let fetchCtrl=null;
// receiver side
let mediaSource=null,sourceBuffer=null,proxyQueue=[],sbReady=false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setPill(cls,txt){document.getElementById('pill').className='pill '+cls;document.getElementById('pillTxt').textContent=txt;}
let toastT;
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');clearTimeout(toastT);toastT=setTimeout(()=>t.classList.remove('show'),2500);}
function setLog(msg,cls=''){const l=document.getElementById('log');l.textContent=msg;l.className='log '+cls;}

function setStep(id,txt,state){
  const el=document.getElementById('step-'+id);
  if(!el)return;
  el.querySelector('.step-icon').textContent=state==='done'?'âœ…':state==='fail'?'âŒ':state==='active'?'â³':'â¬œ';
  el.childNodes[1]&&(el.childNodes[1].textContent='');
  el.textContent='';
  const icon=document.createElement('span');icon.className='step-icon';
  icon.textContent=state==='done'?'âœ…':state==='fail'?'âŒ':state==='active'?'â³':'â¬œ';
  el.appendChild(icon);
  el.appendChild(document.createTextNode(txt));
  el.className='step '+(state||'');
}
function setProgress(pct,label){
  document.getElementById('pbar').style.width=Math.min(100,pct)+'%';
  document.getElementById('pbarLabel').textContent=label;
}

function setConnected(yes){
  document.getElementById('peerN').textContent=yes?2:1;
  document.getElementById('peerTitle').textContent=yes?'2 pessoas â€” sincronizados!':'Sala pronta';
  document.getElementById('peerSub').textContent=yes?'ConexÃ£o WebRTC direta âœ“':'Aguardando outra pessoaâ€¦';
  const row=document.getElementById('avatarRow'),ex=row.querySelector('.p1');
  if(yes&&!ex){const av=document.createElement('div');av.className='av p1';av.textContent='P';row.appendChild(av);}
  else if(!yes&&ex)ex.remove();
  setPill(yes?'connected':'connecting',yes?'Conectado âœ“':'Aguardandoâ€¦');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PEERJS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initPeer(slot,fallback){
  setLog('Conectando ao servidor de sinalizaÃ§Ã£oâ€¦');setPill('connecting','Conectandoâ€¦');
  peer=new Peer(slot,{host:'0.peerjs.com',port:443,path:'/',secure:true,debug:0,
    config:{iceServers:[{urls:'stun:stun.l.google.com:19302'},{urls:'stun:stun1.l.google.com:19302'}]}
  });
  peer.on('open',id=>{
    mySlot=id;theirSlot=id===SLOT_A?SLOT_B:SLOT_A;
    setLog('Sala pronta Â· aguardando parceiroâ€¦','ok');
    setPill('connecting','Aguardando parceiroâ€¦');
    attemptConnect(theirSlot);
  });
  peer.on('connection',c=>setupConn(c));
  peer.on('error',err=>{
    if(err.type==='unavailable-id'&&fallback){peer.destroy();initPeer(fallback,null);return;}
    if(err.type==='peer-unavailable'){clearTimeout(retryTimer);retryTimer=setTimeout(()=>attemptConnect(theirSlot),4000);return;}
    setLog('Erro PeerJS: '+err.type,'err');setPill('error','Erro');
  });
  peer.on('disconnected',()=>peer.reconnect());
}
function attemptConnect(target){
  if(conn&&conn.open)return;
  setupConn(peer.connect(target,{reliable:true,serialization:'binary'}));
}
function setupConn(c){
  c.on('open',()=>{
    conn=c;clearTimeout(retryTimer);setConnected(true);
    setLog('ConexÃ£o P2P estabelecida!','ok');
    const url=document.getElementById('vurl').value.trim();
    if(url)setTimeout(()=>onLoadBtn(url,false),400);
  });
  c.on('data',onData);
  c.on('close',()=>{conn=null;setConnected(false);setLog('Parceiro desconectou.','err');clearTimeout(retryTimer);retryTimer=setTimeout(()=>attemptConnect(theirSlot),3000);});
  c.on('error',e=>setLog('Erro de conexÃ£o: '+e,'err'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BINARY MESSAGING (prefix byte: 0x01=control, 0x02=video chunk)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEC=new TextDecoder();
function sendMsg(obj){
  if(!conn||!conn.open)return;
  const j=JSON.stringify(obj);
  const b=new Uint8Array(j.length+1);b[0]=0x01;
  for(let i=0;i<j.length;i++)b[i+1]=j.charCodeAt(i);
  conn.send(b.buffer);
}
function sendChunk(ab){
  if(!conn||!conn.open)return;
  const s=new Uint8Array(ab),o=new Uint8Array(s.length+1);
  o[0]=0x02;o.set(s,1);conn.send(o.buffer);
}
function onData(raw){
  let arr=raw instanceof ArrayBuffer?new Uint8Array(raw):raw instanceof Uint8Array?raw:null;
  if(!arr){try{handleMsg(typeof raw==='string'?JSON.parse(raw):raw);}catch(e){}return;}
  if(arr[0]===0x01)try{handleMsg(JSON.parse(DEC.decode(arr.slice(1))));}catch(e){console.error(e);}
  else if(arr[0]===0x02)handleChunk(arr.slice(1).buffer);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTROL MESSAGES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleMsg(msg){
  if(!msg?.type)return;
  if(msg.type==='load'){
    ignoring=true;
    loadVideo(msg.url);
    document.getElementById('vurl').value=msg.url;
    showToast('ğŸ¬ Parceiro carregou vÃ­deo');
    setTimeout(()=>{if(typeof msg.currentTime==='number')vid.currentTime=msg.currentTime;if(!msg.paused)vid.play().catch(()=>{});ignoring=false;},900);
    return;
  }
  if(msg.type==='proxy_start'){
    showToast('ğŸ“º Recebendo stream do parceiroâ€¦');
    setLog('Recebendo vÃ­deo via proxyâ€¦','info');
    setupReceiver(msg.mime||'video/mp4; codecs="avc1.42E01E, mp4a.40.2"');
    return;
  }
  if(msg.type==='proxy_done'){
    showToast('âœ… Stream recebido!');
    if(mediaSource?.readyState==='open'){
      const finish=()=>{try{mediaSource.endOfStream();}catch(e){}};
      sourceBuffer?.updating?sourceBuffer.addEventListener('updateend',finish,{once:true}):finish();
    }
    return;
  }
  if(msg.type==='proxy_error'){
    setLog('Parceiro nÃ£o conseguiu buscar: '+msg.msg,'err');
    showToast('âŒ Erro no proxy do parceiro');
    return;
  }
  // playback sync
  ignoring=true;
  if(msg.type==='play'){
    const drift=(Date.now()-msg.ts)/1000;
    const t=msg.currentTime+drift;
    if(Math.abs(vid.currentTime-t)>1.5)vid.currentTime=t;
    vid.play().catch(()=>{});showToast('â–¶ Parceiro deu play');
  }else if(msg.type==='pause'){
    vid.pause();
    if(Math.abs(vid.currentTime-msg.currentTime)>1)vid.currentTime=msg.currentTime;
    showToast('â¸ Parceiro pausou');
  }else if(msg.type==='seek'){
    vid.currentTime=msg.currentTime;showToast('â© Parceiro avanÃ§ou');
  }
  setTimeout(()=>{ignoring=false;},400);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SENDER PROXY â€” fetch with CORS proxy chain, stream via WebRTC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startProxy(url){
  document.getElementById('proxyCard').classList.add('show');
  setPill('proxying','Transmitindoâ€¦');
  fetchCtrl=new AbortController();

  setStep('detect','Link IP-locked detectado (googlevideo)','done');
  setStep('send','Aguardando fetchâ€¦','');

  try{
    const resp=await fetchWithCorsProxy(url,()=>{});
    const ct=resp.headers.get('content-type')||'video/mp4';
    const contentLength=parseInt(resp.headers.get('content-length')||'0');

    // pick mime
    let mime='video/mp4; codecs="avc1.42E01E, mp4a.40.2"';
    if(ct.includes('webm'))mime='video/webm; codecs="vp8, vorbis"';

    sendMsg({type:'proxy_start',mime});
    setStep('send','Enviando chunks para parceiroâ€¦','active');

    const reader=resp.body.getReader();
    let received=0;
    while(true){
      const{done,value}=await reader.read();
      if(done)break;
      sendChunk(value.buffer);
      received+=value.length;
      const mb=(received/1024/1024).toFixed(1);
      const pct=contentLength>0?received/contentLength*100:0;
      setProgress(pct,`${mb} MB enviados${contentLength>0?' / '+(contentLength/1024/1024).toFixed(1)+' MB':''}`);
    }
    sendMsg({type:'proxy_done'});
    setStep('send','TransmissÃ£o completa!','done');
    setProgress(100,'Completo âœ“');
    setPill('connected','Conectado âœ“');

  }catch(e){
    if(e.name==='AbortError')return;
    console.error(e);
    setStep('fetch','Todos os proxies falharam.','fail');
    setStep('send','','');
    sendMsg({type:'proxy_error',msg:e.message});
    setLog('NÃ£o foi possÃ­vel buscar o vÃ­deo via proxy. Tente um link diferente.','err');
    setPill('connected','Conectado');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RECEIVER â€” MediaSource API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setupReceiver(mime){
  if(hls){hls.destroy();hls=null;}
  document.getElementById('ph').style.display='none';
  vid.style.display='block';
  mediaSource=new MediaSource();
  proxyQueue=[];sbReady=false;sourceBuffer=null;
  vid.src=URL.createObjectURL(mediaSource);

  // Try supported mime variants
  const candidates=[mime,'video/mp4; codecs="avc1.42E01E, mp4a.40.2"','video/mp4','video/webm; codecs="vp8, vorbis"','video/webm'];
  const supported=candidates.find(m=>{try{return MediaSource.isTypeSupported(m);}catch(e){return false;}})||'video/mp4';

  mediaSource.addEventListener('sourceopen',()=>{
    try{
      sourceBuffer=mediaSource.addSourceBuffer(supported);
      sourceBuffer.mode='sequence';
      sbReady=true;
      sourceBuffer.addEventListener('updateend',flushQueue);
      flushQueue();
    }catch(e){setLog('MediaSource erro: '+e.message,'err');console.error(e);}
  });
}
function handleChunk(ab){
  proxyQueue.push(ab);
  if(sbReady&&sourceBuffer&&!sourceBuffer.updating)flushQueue();
}
function flushQueue(){
  if(!sbReady||!sourceBuffer||sourceBuffer.updating||!proxyQueue.length)return;
  if(mediaSource?.readyState!=='open')return;
  try{
    sourceBuffer.appendBuffer(proxyQueue.shift());
  }catch(e){
    if(e.name==='QuotaExceededError'&&vid.currentTime>30){
      try{sourceBuffer.remove(0,vid.currentTime-10);proxyQueue.unshift(ab);}catch(e2){}
    }else console.error('appendBuffer:',e);
  }
  if(vid.paused&&vid.readyState>=2)vid.play().catch(()=>{});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLAYER EVENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
vid.addEventListener('play',()=>{if(!ignoring)sendMsg({type:'play',currentTime:vid.currentTime,ts:Date.now()});});
vid.addEventListener('pause',()=>{if(!ignoring)sendMsg({type:'pause',currentTime:vid.currentTime});});
let lastSeek=0;
vid.addEventListener('seeked',()=>{
  if(ignoring)return;const now=Date.now();if(now-lastSeek<500)return;lastSeek=now;
  sendMsg({type:'seek',currentTime:vid.currentTime});
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOAD VIDEO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadVideo(url){
  if(hls){hls.destroy();hls=null;}
  document.getElementById('ph').style.display='none';
  vid.style.display='block';
  if(/\.m3u8/i.test(url)||/m3u8/i.test(url)){
    if(Hls.isSupported()){hls=new Hls({enableWorker:false});hls.loadSource(url);hls.attachMedia(vid);}
    else if(vid.canPlayType('application/vnd.apple.mpegurl'))vid.src=url;
    else setLog('HLS nÃ£o suportado.','err');
  }else{
    vid.src=url;
  }
}

function isIpLocked(url){
  return /googlevideo\.com/.test(url)&&/[?&]ip=/.test(url);
}

function onLoadBtn(url,isLocal){
  const locked=isIpLocked(url);
  // Load locally (our IP works)
  if(isLocal)loadVideo(url);
  if(conn&&conn.open){
    if(locked){
      sendMsg({type:'proxy_start',mime:'video/mp4; codecs="avc1.42E01E, mp4a.40.2"'});
      startProxy(url);
    }else{
      sendMsg({type:'load',url,currentTime:isLocal?vid.currentTime:0,paused:true});
    }
  }
}

function loadAndBroadcast(){
  const url=document.getElementById('vurl').value.trim();
  if(!url)return;
  loadVideo(url);
  onLoadBtn(url,false);
  if(isIpLocked(url)&&(!conn||!conn.open))
    setLog('VÃ­deo carregado. Quando parceiro entrar, proxy iniciarÃ¡ automaticamente.','ok');
}

document.getElementById('vurl').addEventListener('keydown',e=>{if(e.key==='Enter')loadAndBroadcast();});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COPY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function copyLink(){
  navigator.clipboard.writeText(SHARE).then(()=>{
    const c=document.getElementById('copied');c.classList.add('show');setTimeout(()=>c.classList.remove('show'),2000);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// START
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
initPeer(SLOT_A,SLOT_B);
</script>
</body>
</html>
